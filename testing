WITH valid_balances AS (
  SELECT *
  FROM empf_ods.tb_account_balance bal
  WHERE
    bal.acct_type NOT IN ('RESERVE', 'FORFEITURE')
    AND bal.sub_acct_type NOT IN ('RESERVE', 'FORFEITURE')
    AND bal.record_last_updated_by <> 'INFORMATICA_DEL'
    AND bal.scheme_cd = 'RB'
)
SELECT
  pri.scheme_cd AS scheme_code,
  pri.fund_cd AS inv_fund,
  pri.efctv_date AS unit_price_dealing_date,
  SUM(bal.unit_count) AS total_unit,
  pri.bid_price_cnt AS unit_price,
  SUM(bal.unit_count * pri.bid_price_cnt) AS net_asset_value
FROM empf_ods.tb_fund_price pri
JOIN (
  SELECT *
  FROM (
    SELECT *,
      ROW_NUMBER() OVER (
        PARTITION BY sub_acct_type, fund_cd, mbr_acct_cd, pri_date
        ORDER BY eff_date DESC
      ) AS rn
    FROM (
      SELECT b.*, p.efctv_date AS pri_date
      FROM valid_balances b
      JOIN empf_ods.tb_fund_price p ON b.fund_cd = p.fund_cd AND b.eff_date <= p.efctv_date
      WHERE p.scheme_cd = 'RB' AND p.delete_flag = 'N'
    ) t
  ) x
  WHERE rn = 1
) bal ON pri.fund_cd = bal.fund_cd AND pri.efctv_date = bal.pri_date
WHERE pri.efctv_date BETWEEN '2025-04-07' AND '2025-04-13'
GROUP BY
  pri.scheme_cd,
  pri.fund_cd,
  pri.efctv_date,
  pri.bid_price_cnt
ORDER BY
  pri.fund_cd,
  pri.efctv_date DESC;


-- ğŸ” è°ƒè¯•å‚æ•°ï¼š
-- æ›¿æ¢ä¸ºä½ å…³æ³¨çš„ NAV æŠ¥è¡¨æ—¥æœŸ & åŸºé‡‘ä»£ç 
WITH nav_date_target AS (
  SELECT 
    DATE '2025-04-07' AS nav_date,   -- ğŸ‘ˆ Replace with your target NAV date
    'CRCPF' AS target_fund           -- ğŸ‘ˆ Replace with your fund code
),

-- 1ï¸âƒ£ æ‰¾å‡ºè¯¥åŸºé‡‘åœ¨è¯¥ NAV æ—¥æœŸä¸‹çš„æœ‰æ•ˆåŸºé‡‘ä»·æ ¼è®°å½•ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰
valid_fund_price AS (
  SELECT *
  FROM tb_fund_price f
  JOIN nav_date_target t
    ON f.efctv_date = t.nav_date AND f.fund_cd = t.target_fund
  WHERE f.scheme_cd = 'RB'
    AND f.delete_flag = 'N'
),

-- 2ï¸âƒ£ æ‰¾å‡ºæ‰€æœ‰ç¬¦åˆè¯¥ NAV æ—¥æœŸæ¡ä»¶çš„è´¦æˆ·ä½™é¢è®°å½•ï¼ˆç”¨äº unit æ±‡æ€»ï¼‰
valid_account_balance AS (
  SELECT 
    b.*,
    ROW_NUMBER() OVER (
      PARTITION BY b.sub_acct_type, b.fund_cd, b.mbr_acct_cd
      ORDER BY b.eff_date DESC
    ) AS rn
  FROM tb_account_balance b
  JOIN nav_date_target t
    ON b.fund_cd = t.target_fund
  JOIN valid_fund_price p
    ON b.fund_cd = p.fund_cd
  WHERE b.scheme_cd = 'RB'
    AND b.acct_type NOT IN ('RESERVE', 'FORFEITURE')
    AND b.sub_acct_type NOT IN ('RESERVE', 'FORFEITURE')
    AND b.record_last_updated_by <> 'INFORMATICA_DEL'
    AND b.eff_date <= p.efctv_date
)

-- 3ï¸âƒ£ æœ€ç»ˆè¾“å‡ºæ‰€æœ‰è¢«è®¡å…¥ total_unit çš„è®°å½•
SELECT 
  b.mbr_acct_cd,
  b.fund_cd,
  b.eff_date,
  b.unit_count,
  b.acct_type,
  b.sub_acct_type,
  b.delete_flag,
  b.record_last_updated_by,
  p.efctv_date AS nav_date,
  p.bid_price_cnt AS unit_price,
  b.unit_count * p.bid_price_cnt AS partial_nav
FROM valid_account_balance b
JOIN valid_fund_price p
  ON b.fund_cd = p.fund_cd
WHERE b.rn = 1
ORDER BY b.eff_date DESC;





-- 1. é¢„è¿‡æ»¤åˆæ³•è´¦æˆ·è®°å½•
WITH valid_balances AS (
  SELECT *
  FROM empf_ods.tb_account_balance bal
  WHERE
    bal.acct_type NOT IN ('RESERVE', 'FORFEITURE')
    AND bal.sub_acct_type NOT IN ('RESERVE', 'FORFEITURE')
    AND bal.record_last_updated_by <> 'INFORMATICA_DEL'
    AND bal.scheme_cd = 'RB'
    AND bal.delete_flag = 'N'
),

-- 2. ç”Ÿæˆæ‰€æœ‰ NAV æ—¥ä¸åˆè§„è´¦æˆ·è®°å½•çš„äº¤å‰ç»„åˆï¼ˆå¹¶é™åˆ¶ eff_date â‰¤ efctv_dateï¼‰
balance_with_nav_date AS (
  SELECT
    b.*,
    p.efctv_date AS pri_date,
    p.bid_price_cnt
  FROM valid_balances b
  JOIN empf_ods.tb_fund_price p
    ON b.fund_cd = p.fund_cd
   AND b.eff_date <= p.efctv_date
  WHERE p.scheme_cd = 'RB'
    AND p.delete_flag = 'N'
),

-- 3. æ¯ä¸ª NAV æ—¥ & åŸºé‡‘ & è´¦æˆ·ç»„åˆé€‰å‡ºæœ€æ¥è¿‘çš„ä¸€æ¡è®°å½•ï¼ˆeff_date æœ€å¤§ï¼‰
latest_valid_balances AS (
  SELECT *
  FROM (
    SELECT *,
      ROW_NUMBER() OVER (
        PARTITION BY sub_acct_type, fund_cd, mbr_acct_cd, pri_date
        ORDER BY eff_date DESC
      ) AS rn
    FROM balance_with_nav_date
  ) ranked
  WHERE rn = 1
)

-- 4. æ±‡æ€»ç”Ÿæˆ NAV æŠ¥è¡¨
SELECT
  p.scheme_cd AS scheme_code,
  p.fund_cd AS inv_fund,
  p.efctv_date AS unit_price_dealing_date,
  SUM(b.unit_count) AS total_unit,
  p.bid_price_cnt AS unit_price,
  SUM(b.unit_count * p.bid_price_cnt) AS net_asset_value
FROM empf_ods.tb_fund_price p
JOIN latest_valid_balances b
  ON p.fund_cd = b.fund_cd
 AND p.efctv_date = b.pri_date
WHERE p.scheme_cd = 'RB'
  AND p.delete_flag = 'N'
  AND p.efctv_date BETWEEN DATE '2025-04-07' AND DATE '2025-04-13'
GROUP BY
  p.scheme_cd,
  p.fund_cd,
  p.efctv_date,
  p.bid_price_cnt
ORDER BY
  p.fund_cd,
  p.efctv_date DESC;





#########

Sub HighlightFRSFilteredNAVRecords()
    Dim ws As Worksheet
    Set ws = ActiveSheet

    ' --- è®¾ç½®è¾“å…¥å‚æ•° ---
    Dim rng As Range
    Set rng = ws.Range("A37:K51") ' æ•°æ®åŒºåŸŸï¼ˆä¸å«åˆ—åï¼‰

    Dim efctv_date As Date
    efctv_date = DateValue("2026-04-16") ' è®¾ç½® efctv_date

    ' --- è·å–åˆ—å·å®šä¹‰ ---
    Const COL_DELETE_FLAG = 1
    Const COL_SCHEME_CD = 2
    Const COL_EMPLR_ACCT_CD = 3
    Const COL_PAYROLL_GROUP_ID = 4
    Const COL_MBR_ACCT_CD = 5
    Const COL_ACCT_TYPE = 6
    Const COL_SUB_ACCT_TYPE = 7
    Const COL_EFF_DATE = 8
    Const COL_FUND_CD = 9
    Const COL_UNIT_COUNT = 10
    Const COL_UPDATED_BY = 11

    ' --- æ¸…é™¤æ‰€æœ‰åŸæœ‰å¡«è‰² ---
    rng.Interior.Pattern = xlNone

    Dim i As Long, lastRow As Long
    Dim dict As Object: Set dict = CreateObject("Scripting.Dictionary")
    Dim key As String

    ' --- ç¬¬ä¸€æ¬¡éå†ï¼šæ„å»ºæœ€æ–° eff_dateï¼ˆâ‰¤ efctv_dateï¼‰ çš„åˆ†ç»„è®°å½• ---
    For i = 1 To rng.Rows.Count
        Dim rowEffDate As Variant: rowEffDate = rng.Cells(i, COL_EFF_DATE).Value
        If IsDate(rowEffDate) Then
            If CDate(rowEffDate) <= efctv_date Then
                Dim acct_type As String: acct_type = Trim(UCase(rng.Cells(i, COL_ACCT_TYPE).Value))
                Dim sub_acct_type As String: sub_acct_type = Trim(UCase(rng.Cells(i, COL_SUB_ACCT_TYPE).Value))
                Dim updated_by As String: updated_by = Trim(UCase(rng.Cells(i, COL_UPDATED_BY).Value))
                Dim delete_flag As String: delete_flag = Trim(UCase(rng.Cells(i, COL_DELETE_FLAG).Value))

                ' æ’é™¤ä¸ç¬¦åˆçš„è®°å½•
                If acct_type <> "RESERVE" And acct_type <> "FORFEITURE" _
                And sub_acct_type <> "RESERVE" And sub_acct_type <> "FORFEITURE" _
                And updated_by <> "INFORMATICA_DEL" _
                And delete_flag = "N" Then

                    ' æ„å»ºåˆ†ç»„ key
                    key = sub_acct_type & "|" & rng.Cells(i, COL_FUND_CD).Value & "|" & rng.Cells(i, COL_MBR_ACCT_CD).Value

                    ' å¦‚æœè¯¥ç»„æ²¡è®°å½•æˆ–æ›´æ™šçš„ eff_dateï¼Œæ›´æ–°è¯¥ç»„
                    If Not dict.exists(key) Then
                        dict.Add key, i
                    Else
                        Dim prevRow As Long: prevRow = dict(key)
                        If rng.Cells(i, COL_EFF_DATE).Value > rng.Cells(prevRow, COL_EFF_DATE).Value Then
                            dict(key) = i
                        End If
                    End If
                End If
            End If
        End If
    Next i

    ' --- ç¬¬äºŒæ¬¡éå†ï¼šé«˜äº®é€‰ä¸­è¡Œ ---
    Dim r As Long
    For Each key In dict.Keys
        r = dict(key)
        rng.Rows(r).Interior.Color = RGB(198, 239, 206) ' æµ…ç»¿è‰²
    Next key

    MsgBox "ç­›é€‰å¹¶é«˜äº®å®Œæˆï¼å…±é«˜äº® " & dict.Count & " æ¡è®°å½•ã€‚", vbInformation
End Sub

