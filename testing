import ctypes
import time
from IPython.display import clear_output

# 防止系统进入空闲状态的结构体
class LASTINPUTINFO(ctypes.Structure):
    _fields_ = [('cbSize', ctypes.c_uint), ('dwTime', ctypes.c_uint)]

# 调用 Windows API 设置系统状态为活跃
def prevent_sleep():
    ctypes.windll.kernel32.SetThreadExecutionState(0x80000002)

# 显示运行状态（防止 Jupyter kernel 被 kill）
run_minutes = 120
interval = 30  # 每30秒刷新/激活一次
print(f"🟢 开始防掉线（防Teams离开、系统锁屏）。预计持续运行 {run_minutes} 分钟，每 {interval} 秒刷新一次。")

try:
    for i in range(int(run_minutes * 60 / interval)):
        prevent_sleep()
        clear_output(wait=True)
        print(f"✅ 第 {i+1} 次激活系统，已运行 {((i+1)*interval)//60} 分钟")
        time.sleep(interval)

    print("🟢 防掉线任务完成")

except KeyboardInterrupt:
    print("⛔ 已手动终止防掉线脚本")
